<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØµØ­ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1b5e20; --gold: #c5a059; --bg: #fdfdfd; --text: #333; }
        body.dark { --bg: #1a1a1a; --text: #e0e0e0; --primary: #2e7d32; }
        body { margin: 0; font-family: 'Amiri', serif; background: var(--bg); color: var(--text); overflow: hidden; touch-action: none; }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
        header, footer { position: fixed; width: 100%; background: var(--primary); z-index: 1000; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        header { top: 0; padding: 10px 0; }
        footer { bottom: 0; padding: 12px 0; border-radius: 15px 15px 0 0; }

        .btn { color: white; cursor: pointer; font-size: 13px; text-align: center; }
        .color-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid white; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        #main-view { height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 60px 0; box-sizing: border-box; }
        .page-card { width: 92%; height: 100%; background: white; border: 4px double var(--gold); border-radius: 15px; padding: 20px; overflow-y: auto; position: relative; }
        body.dark .page-card { background: #252525; }
        .word { display: inline-block; padding: 0 1px; border-radius: 4px; }
        .has-note { border-bottom: 2px dashed var(--gold); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 70%; background: var(--bg); z-index: 2000; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; border-top: 3px solid var(--gold); }
        .panel.active { bottom: 0; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--gold); font-family: 'Amiri'; margin-bottom: 10px; }
    </style>
</head>
<body ontouchstart="ts(event)" ontouchend="te(event)">

    <header onclick="event.stopPropagation()">
        <div style="display:flex; gap:10px;">
            <div class="color-dot" style="background:#ffeb3b" onclick="setCol('#ffeb3b')"></div>
            <div class="color-dot" style="background:#ff5252" onclick="setCol('#ff5252')"></div>
            <div class="color-dot" style="background:#64ffda" onclick="setCol('#64ffda')"></div>
        </div>
        <div class="btn" onclick="undo()">â†© ØªØ±Ø§Ø¬Ø¹</div>
        <div class="btn" onclick="toggleDark()">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹</div>
    </header>

    <div id="main-view">
        <div class="page-card" id="content" onclick="event.stopPropagation()">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div id="notes-panel" class="panel">
        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</h3>
        <div id="notes-list"></div>
        <button onclick="closeP()" style="width:100%; padding:10px; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="search-panel" class="panel">
        <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¢ÙŠØ©..." oninput="search(this.value)">
        <div id="results"></div>
        <button onclick="closeP()" style="width:100%; padding:10px; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <footer>
        <div class="btn" onclick="openP('notes-panel')">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <div id="sura-label" style="font-weight:bold; color:var(--gold); font-size:16px;"></div>
        <div class="btn" onclick="openP('search-panel')">ğŸ” Ø§Ù„Ø¨Ø­Ø«</div>
    </footer>

    <script>
        let cur = parseInt(localStorage.getItem('lastSura')) || 0;
        let col = '#ffeb3b';
        let data = [];
        let hls = JSON.parse(localStorage.getItem('myHls')) || [];
        let nts = JSON.parse(localStorage.getItem('myNts')) || {};
        let xd = null, pt;

        async function init() {
            const res = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
            const d = await res.json();
            data = d.data.surahs;
            render();
            updateNotes();
        }

        function render() {
            const s = data[cur];
            document.getElementById('sura-label').innerText = s.name;
            let h = `<h2 style="text-align:center">${s.name}</h2>`;
            s.ayahs.forEach((a, ai) => {
                const aid = `s${cur}a${ai}`;
                h += `<span class="${nts[aid]?'has-note':''}" onmousedown="st('${aid}')" onmouseup="en()" ontouchstart="st('${aid}')" ontouchend="en()">`;
                a.text.split(' ').forEach((w, wi) => {
                    const wid = `${aid}w${wi}`;
                    const hl = hls.find(x => x.id === wid);
                    h += `<span id="${wid}" class="word" ${hl?`style="background:${hl.color}"`:''} onclick="high('${wid}','${w}')">${w}</span> `;
                });
                h += `(${ai+1}) </span>`;
            });
            document.getElementById('content').innerHTML = h;
            localStorage.setItem('lastSura', cur);
            document.getElementById('content').scrollTop = 0;
        }

        function high(id, t) {
            const e = document.getElementById(id);
            if(e.style.background && e.style.background !== 'transparent') {
                e.style.background = '';
                hls = hls.filter(x => x.id !== id);
            } else {
                e.style.background = col;
                hls.push({id, t, color: col});
            }
            localStorage.setItem('myHls', JSON.stringify(hls));
        }

        function undo() {
            const l = hls.pop();
            if(l) { const e = document.getElementById(l.id); if(e) e.style.background = ''; localStorage.setItem('myHls', JSON.stringify(hls)); }
        }

        function st(id) { pt = setTimeout(() => {
            const m = prompt("Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ:", nts[id]?.text || "");
            if(m !== null) {
                if(m) nts[id] = {text: m, sura: data[cur].name}; else delete nts[id];
                localStorage.setItem('myNts', JSON.stringify(nts));
                render(); updateNotes();
            }
        }, 800); }
        function en() { clearTimeout(pt); }

        function updateNotes() {
            document.getElementById('notes-list').innerHTML = Object.values(nts).map(n => 
                `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${n.sura}:</b> ${n.text}</div>`).join('') || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
        }

        function search(q) {
            let r = '';
            if(q.length > 1) {
                data.forEach((s, si) => s.ayahs.forEach(a => {
                    if(a.text.includes(q)) r += `<div onclick="go(${si})" style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}:</b> ${a.text}</div>`;
                }));
            }
            document.getElementById('results').innerHTML = r;
        }

        function go(i) { cur = i; render(); closeP(); }
        function ts(e) { xd = e.touches[0].clientX; }
        function te(e) {
            let xu = e.changedTouches[0].clientX;
            if(!xd || Math.abs(xd-xu) < 50) return;
            if(xd > xu) { if(cur < 113) cur++; } else { if(cur > 0) cur--; }
            render(); xd = null;
        }

        function openP(id) { document.getElementById(id).classList.add('active'); }
        function closeP() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); }
        function setCol(c) { col = c; }
        function toggleDark() { document.body.classList.toggle('dark'); }

        init();
    </script>
</body>
</html>
