<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø·ÙˆØ± - Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªÙ„ÙˆÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1b5e20; --gold: #c5a059; --bg: #fdfdfd; --text: #333; }
        body.dark { --bg: #1a1a1a; --text: #e0e0e0; --primary: #2e7d32; }
        body { margin: 0; font-family: 'Amiri', serif; background: var(--bg); color: var(--text); transition: 0.3s; overflow: hidden; }
        header { background: var(--primary); color: white; padding: 10px; text-align: center; display: flex; justify-content: space-around; align-items: center; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        .color-bar { display: flex; gap: 8px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; }
        .color-dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid white; }
        .c1 { background: #ffeb3b; } .c2 { background: #ff5252; } .c3 { background: #64ffda; } .c4 { background: #e1bee7; } .c5 { background: #ffb74d; }
        
        #quran-container { height: calc(100vh - 160px); display: flex; align-items: center; justify-content: center; padding: 15px; }
        .page-card { width: 100%; max-width: 500px; height: 100%; background: white; border: 6px double var(--gold); border-radius: 15px; padding: 25px; box-sizing: border-box; overflow-y: auto; position: relative; }
        body.dark .page-card { background: #252525; }
        
        .word { cursor: pointer; display: inline-block; padding: 0 2px; border-radius: 4px; user-select: none; }
        .has-note { border-bottom: 2px dashed var(--gold); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Ø¨Ø­Ø«ØŒ Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ù…Ù„ÙˆÙ†Ø§Øª) */
        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--bg); z-index: 300; transition: 0.4s; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .panel.active { bottom: 0; }
        
        footer { position: fixed; bottom: 0; width: 100%; background: var(--primary); display: flex; justify-content: space-around; padding: 10px 0; color: white; align-items: center; }
        .btn { cursor: pointer; font-size: 13px; text-align: center; display: flex; flex-direction: column; align-items: center; }

        textarea { width: 100%; height: 100px; margin-top: 10px; font-family: 'Amiri'; font-size: 18px; padding: 10px; border-radius: 10px; border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <header>
        <div class="btn" onclick="togglePanel('highlights-panel')">ğŸ“‹ Ø§Ù„Ù…Ù„ÙˆÙ†Ø§Øª</div>
        <div class="color-bar">
            <div class="color-dot c1" onclick="selectedColor='#ffeb3b'"></div>
            <div class="color-dot c2" onclick="selectedColor='#ff5252'"></div>
            <div class="color-dot c3" onclick="selectedColor='#64ffda'"></div>
            <div class="color-dot c4" onclick="selectedColor='#e1bee7'"></div>
            <div class="color-dot c5" onclick="selectedColor='#ffb74d'"></div>
        </div>
        <div class="btn" onclick="undoLast()">â†© ØªØ±Ø§Ø¬Ø¹</div>
    </header>

    <div id="notes-panel" class="panel">
        <h3 style="text-align:center">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <div id="notes-list"></div>
        <button onclick="togglePanel('notes-panel')" style="width:100%; margin-top:20px; padding:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="write-note-panel" class="panel" style="height: 40%;">
        <h3 id="note-title">ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
        <textarea id="note-text" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        <button onclick="saveNote()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
    </div>

    <div id="quran-container">
        <div class="page-card" id="content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <footer>
        <div onclick="prevPage()" class="btn">â—€</div>
        <div onclick="togglePanel('notes-panel')" class="btn">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <select id="sura-select" onchange="goToSura(this.value)" style="width:25%"></select>
        <div onclick="toggleSearch()" class="btn">ğŸ” Ø¨Ø­Ø«</div>
        <div onclick="toggleDark()" class="btn">ğŸŒ™</div>
        <div onclick="nextPage()" class="btn">â–¶</div>
    </footer>

    <script>
        let currentSura = parseInt(localStorage.getItem('lastSura')) || 0;
        let quranData = [];
        let selectedColor = '#ffeb3b';
        let highlights = JSON.parse(localStorage.getItem('myHighlights')) || [];
        let notes = JSON.parse(localStorage.getItem('myNotes')) || {}; 
        let activeAyahId = null;
        let pressTimer;

        async function loadQuran() {
            const res = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
            const data = await res.json();
            quranData = data.data.surahs;
            fillSelect();
            render();
            updateNotesList();
        }

        function render() {
            const sura = quranData[currentSura];
            let html = '';
            sura.ayahs.forEach((a, ayIdx) => {
                const ayahId = `s${currentSura}a${ayIdx}`;
                html += `<span class="ayah-block ${notes[ayahId] ? 'has-note' : ''}" 
                        onmousedown="startPress('${ayahId}')" onmouseup="endPress()" 
                        ontouchstart="startPress('${ayahId}')" ontouchend="endPress()">`;
                
                a.text.split(' ').forEach((word, wIdx) => {
                    const wordId = `${ayahId}w${wIdx}`;
                    const h = highlights.find(x => x.id === wordId);
                    html += `<span id="${wordId}" class="word" ${h ? `style="background:${h.color}"` : ''} 
                            onclick="highlightWord('${wordId}','${word}')">${word}</span> `;
                });
                html += `<span style="color:var(--primary); font-weight:bold;"> (${ayIdx+1}) </span></span>`;
            });
            document.getElementById('content').innerHTML = html;
            localStorage.setItem('lastSura', currentSura);
        }

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        function startPress(id) {
            pressTimer = window.setTimeout(() => {
                activeAyahId = id;
                document.getElementById('note-title').innerText = "Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰ Ø¢ÙŠØ© ÙÙŠ " + quranData[currentSura].name;
                document.getElementById('note-text').value = notes[id] || "";
                togglePanel('write-note-panel');
            }, 800); 
        }
        function endPress() { clearTimeout(pressTimer); }

        function saveNote() {
            const text = document.getElementById('note-text').value;
            if (text.trim()) {
                notes[activeAyahId] = { text, sura: quranData[currentSura].name, id: activeAyahId };
            } else {
                delete notes[activeAyahId];
            }
            localStorage.setItem('myNotes', JSON.stringify(notes));
            togglePanel('write-note-panel');
            render();
            updateNotesList();
        }

        function updateNotesList() {
            const list = document.getElementById('notes-list');
            list.innerHTML = Object.values(notes).map(n => `
                <div style="padding:10px; border-bottom:1px solid #ddd;">
                    <strong>${n.sura}:</strong> <p>${n.text}</p>
                </div>
            `).join('') || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©";
        }

        function togglePanel(id) { document.getElementById(id).classList.toggle('active'); }
        function highlightWord(id, text) {
            const el = document.getElementById(id);
            if (el.style.background) {
                el.style.background = '';
                highlights = highlights.filter(h => h.id !== id);
            } else {
                el.style.background = selectedColor;
                highlights.push({ id, text, color: selectedColor });
            }
            localStorage.setItem('myHighlights', JSON.stringify(highlights));
        }

        function fillSelect() {
            document.getElementById('sura-select').innerHTML = quranData.map((s, i) => 
                `<option value="${i}" ${i === currentSura ? 'selected' : ''}>${s.name}</option>`).join('');
        }

        function goToSura(i) { currentSura = parseInt(i); render(); }
        function nextPage() { if(currentSura < 113) { currentSura++; render(); } }
        function prevPage() { if(currentSura > 0) { currentSura--; render(); } }
        function toggleDark() { document.body.classList.toggle('dark'); }

        loadQuran();
    </script>
</body>
</html>
