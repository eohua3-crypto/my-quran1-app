<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØµØ­ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1b5e20; --gold: #c5a059; --bg: #fdfdfd; --text: #333; }
        body.dark { --bg: #1a1a1a; --text: #e0e0e0; --primary: #2e7d32; }
        body { margin: 0; font-family: 'Amiri', serif; background: var(--bg); color: var(--text); overflow: hidden; touch-action: none; }
        
        header, footer { position: fixed; width: 100%; background: var(--primary); transition: 0.3s; z-index: 1000; display: flex; justify-content: space-around; align-items: center; }
        header { top: -100px; padding: 10px 0; }
        footer { bottom: -100px; padding: 12px 0; border-radius: 15px 15px 0 0; }
        header.active { top: 0; }
        footer.active { bottom: 0; }

        .btn { color: white; cursor: pointer; font-size: 13px; text-align: center; padding: 5px; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        .active-pen { border: 2px solid #fff; background: rgba(255,255,255,0.2); border-radius: 8px; }
        
        #main-view { height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; }
        .page-card { width: 92%; height: 85%; background: white; border: 4px double var(--gold); border-radius: 15px; padding: 20px; overflow-y: auto; position: relative; }
        body.dark .page-card { background: #252525; }
        .word { display: inline-block; padding: 0 1px; border-radius: 4px; transition: 0.2s; }
        .has-note { border-bottom: 2px dashed var(--gold); }

        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 70%; background: var(--bg); z-index: 2000; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; border-top: 3px solid var(--gold); }
        .panel.active { bottom: 0; }
    </style>
</head>
<body onclick="toggleAllMenus()" ontouchstart="ts(event)" ontouchend="te(event)">

    <header id="h-menu">
        <div style="display:flex; gap:12px;" onclick="event.stopPropagation()">
            <div class="color-dot" style="background:#ffeb3b" onclick="setCol('#ffeb3b')"></div>
            <div class="color-dot" style="background:#ff5252" onclick="setCol('#ff5252')"></div>
            <div class="color-dot" style="background:#64ffda" onclick="setCol('#64ffda')"></div>
        </div>
        <div class="btn" onclick="undo(event)">â†© ØªØ±Ø§Ø¬Ø¹</div>
        <div class="btn" onclick="toggleDark(event)">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹</div>
    </header>

    <div id="main-view">
        <div class="page-card" id="content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div id="n-panel" class="panel" onclick="event.stopPropagation()">
        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ</h3>
        <div id="n-list"></div>
        <button onclick="closeP()" style="width:100%; padding:10px; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="s-panel" class="panel" onclick="event.stopPropagation()">
        <input type="text" placeholder="Ø§Ø¨Ø­Ø«..." oninput="doSearch(this.value)" style="width:90%; padding:10px; font-family:'Amiri'">
        <div id="results"></div>
        <button onclick="closeP()" style="width:100%; padding:10px; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <footer id="f-menu">
        <div class="btn" onclick="openP('n-panel', event)">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <div class="btn" id="pen-btn" onclick="togglePenMode(event)">âœï¸ Ø§Ù„Ù‚Ù„Ù…: <span id="pen-status">Ù…ØºÙ„Ù‚</span></div>
        <div id="sura-name" style="font-weight:bold; color:var(--gold); font-size:15px;"></div>
        <div class="btn" onclick="openP('s-panel', event)">ğŸ” Ø¨Ø­Ø«</div>
    </footer>

    <script>
        let cur = parseInt(localStorage.getItem('lastSura')) || 0;
        let col = '#ffeb3b';
        let isPenActive = false; // Ø§Ù„Ù‚Ù„Ù… Ù…ØºÙ„Ù‚ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        let data = [];
        let hls = JSON.parse(localStorage.getItem('myHls')) || [];
        let nts = JSON.parse(localStorage.getItem('myNts')) || {};
        let xd = null, pt;

        async function init() {
            const res = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
            const d = await res.json();
            data = d.data.surahs;
            render();
            updateN();
        }

        function render() {
            const s = data[cur];
            document.getElementById('sura-name').innerText = s.name;
            let h = `<h2 style="text-align:center">${s.name}</h2>`;
            s.ayahs.forEach((a, ai) => {
                const aid = `s${cur}a${ai}`;
                h += `<span class="${nts[aid]?'has-note':''}" onmousedown="st('${aid}')" onmouseup="en()" ontouchstart="st('${aid}')" ontouchend="en()">`;
                a.text.split(' ').forEach((w, wi) => {
                    const wid = `${aid}w${wi}`;
                    const hl = hls.find(x => x.id === wid);
                    h += `<span id="${wid}" class="word" ${hl?`style="background:${hl.color}"`:''} onclick="high('${wid}','${w}', event)">${w}</span> `;
                });
                h += `(${ai+1}) </span>`;
            });
            document.getElementById('content').innerHTML = h;
            localStorage.setItem('lastSura', cur);
        }

        // Ø§Ù„ØªÙ„ÙˆÙŠÙ† ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ù„Ù… Ù…ÙØ¹Ù„Ø§Ù‹
        function high(id, t, e) {
            if(!isPenActive) return; // Ù„Ø§ ØªÙ„ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ù„Ù… Ù…ØºÙ„Ù‚Ø§Ù‹
            e.stopPropagation();
            const el = document.getElementById(id);
            if(el.style.background && el.style.background !== 'transparent') {
                el.style.background = '';
                hls = hls.filter(x => x.id !== id);
            } else {
                el.style.background = col;
                hls.push({id, t, color: col});
            }
            localStorage.setItem('myHls', JSON.stringify(hls));
        }

        function togglePenMode(e) {
            e.stopPropagation();
            isPenActive = !isPenActive;
            document.getElementById('pen-status').innerText = isPenActive ? "Ù…ÙØ¹Ù„" : "Ù…ØºÙ„Ù‚";
            document.getElementById('pen-btn').classList.toggle('active-pen');
        }

        function toggleAllMenus() {
            document.getElementById('h-menu').classList.toggle('active');
            document.getElementById('f-menu').classList.toggle('active');
        }

        function undo(e) { e.stopPropagation(); const l = hls.pop(); if(l) { const el = document.getElementById(l.id); if(el) el.style.background = ''; localStorage.setItem('myHls', JSON.stringify(hls)); } }
        function setCol(c) { col = c; }
        function openP(id, e) { e.stopPropagation(); document.getElementById(id).classList.add('active'); }
        function closeP() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); }
        function toggleDark(e) { e.stopPropagation(); document.body.classList.toggle('dark'); }

        function st(id) { pt = setTimeout(() => {
            const m = prompt("Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ:", nts[id]?.text || "");
            if(m !== null) {
                if(m) nts[id] = {text: m, sura: data[cur].name}; else delete nts[id];
                localStorage.setItem('myNts', JSON.stringify(nts));
                render(); updateN();
            }
        }, 800); }
        function en() { clearTimeout(pt); }

        function updateN() {
            document.getElementById('n-list').innerHTML = Object.values(nts).map(n => 
                `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${n.sura}:</b> ${n.text}</div>`).join('') || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";
        }

        function doSearch(q) {
            let r = '';
            if(q.length > 1) {
                data.forEach((s, si) => s.ayahs.forEach(a => {
                    if(a.text.includes(q)) r += `<div onclick="go(${si})" style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}:</b> ${a.text}</div>`;
                }));
            }
            document.getElementById('results').innerHTML = r;
        }

        function go(i) { cur = i; render(); closeP(); }
        function ts(e) { xd = e.touches[0].clientX; }
        function te(e) {
            let xu = e.changedTouches[0].clientX;
            if(!xd || Math.abs(xd-xu) < 60) return;
            if(xd > xu) { if(cur < 113) cur++; } else { if(cur > 0) cur--; }
            render(); xd = null;
        }

        init();
    </script>
</body>
</html>
