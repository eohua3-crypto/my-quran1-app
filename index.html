<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØµØ­ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1b5e20; --gold: #c5a059; --bg: #fdfdfd; --text: #333; }
        body.dark { --bg: #1a1a1a; --text: #e0e0e0; --primary: #2e7d32; }
        body { margin: 0; font-family: 'Amiri', serif; background: var(--bg); color: var(--text); overflow: hidden; touch-action: none; }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø°ÙƒÙŠØ© */
        header, footer { position: fixed; width: 100%; background: var(--primary); transition: 0.3s; z-index: 1000; display: flex; justify-content: space-around; align-items: center; }
        header { top: -120px; padding: 10px 0; }
        footer { bottom: -120px; padding: 12px 0; border-radius: 15px 15px 0 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
        header.active { top: 0; }
        footer.active { bottom: 0; }

        .btn { color: white; cursor: pointer; font-size: 13px; text-align: center; padding: 5px; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ */
        #main-view { height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; }
        .page-card { width: 92%; height: 85%; background: white; border: 4px double var(--gold); border-radius: 15px; padding: 20px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        body.dark .page-card { background: #252525; }
        .word { display: inline-block; padding: 0 2px; border-radius: 4px; transition: 0.2s; }
        .has-note { border-bottom: 2px dashed var(--gold); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--bg); z-index: 2000; transition: 0.4s; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .panel.active { bottom: 0; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--gold); font-family: 'Amiri'; margin-bottom: 10px; }
    </style>
</head>
<body onclick="toggleMenus()" ontouchstart="handleTS(event)" ontouchend="handleTE(event)">

    <header id="pen-tools" onclick="event.stopPropagation()">
        <div style="display:flex; gap:12px;">
            <div class="color-dot" style="background:#ffeb3b" onclick="setCol('#ffeb3b')"></div>
            <div class="color-dot" style="background:#ff5252" onclick="setCol('#ff5252')"></div>
            <div class="color-dot" style="background:#64ffda" onclick="setCol('#64ffda')"></div>
        </div>
        <div class="btn" onclick="undoHighlight()">â†© ØªØ±Ø§Ø¬Ø¹</div>
        <div class="btn" onclick="hidePen()" style="color:#ffb3b3">Ø¥ØºÙ„Ø§Ù‚ âœ–</div>
    </header>

    <div id="main-view">
        <div class="page-card" id="content" onclick="event.stopPropagation()">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ­Ù...</div>
    </div>

    <div id="notes-list-panel" class="panel" onclick="event.stopPropagation()">
        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <div id="notes-container"></div>
        <button onclick="closePanels()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="search-panel" class="panel" onclick="event.stopPropagation()">
        <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¢ÙŠØ© Ø£Ùˆ ÙƒÙ„Ù…Ø©..." oninput="doSearch(this.value)">
        <div id="results" style="margin-top:10px;"></div>
        <button onclick="closePanels()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <footer id="main-footer" onclick="event.stopPropagation()">
        <div class="btn" onclick="openPanel('notes-list-panel')">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <div class="btn" onclick="showPenTools()">âœï¸ Ø§Ù„Ù‚Ù„Ù…</div>
        <div class="btn" id="sura-label" style="font-weight:bold; color:var(--gold); font-size:16px;"></div>
        <div class="btn" onclick="openPanel('search-panel')">ğŸ” Ø¨Ø­Ø«</div>
        <div class="btn" onclick="toggleDarkMode()">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹</div>
    </footer>

    <script>
        let curSura = parseInt(localStorage.getItem('lastSura')) || 0;
        let activeColor = '#ffeb3b';
        let quranData = [];
        let highlights = JSON.parse(localStorage.getItem('myHighlights')) || [];
        let ayahNotes = JSON.parse(localStorage.getItem('myNotes')) || {};
        let touchX = null, pressTimer;

        async function initApp() {
            const res = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
            const d = await res.json();
            quranData = d.data.surahs;
            renderPage();
            refreshNotesUI();
        }

        function renderPage() {
            const s = quranData[curSura];
            document.getElementById('sura-label').innerText = s.name;
            let html = `<h2 style="text-align:center; color:var(--primary)">${s.name}</h2>`;
            s.ayahs.forEach((a, ai) => {
                const aid = `s${curSura}a${ai}`;
                html += `<span class="${ayahNotes[aid]?'has-note':''}" 
                        onmousedown="startNoteTimer('${aid}')" onmouseup="clearNoteTimer()" 
                        ontouchstart="startNoteTimer('${aid}')" ontouchend="clearNoteTimer()">`;
                a.text.split(' ').forEach((w, wi) => {
                    const wid = `${aid}w${wi}`;
                    const hl = highlights.find(x => x.id === wid);
                    html += `<span id="${wid}" class="word" ${hl?`style="background:${hl.color}"`:''} 
                            onclick="handleWordClick('${wid}','${w}')">${w}</span> `;
                });
                html += `<span style="color:var(--gold)">(${ai+1})</span></span> `;
            });
            document.getElementById('content').innerHTML = html;
            localStorage.setItem('lastSura', curSura);
            document.getElementById('content').scrollTop = 0;
        }

        function handleWordClick(id, text) {
            const el = document.getElementById(id);
            if(el.style.background && el.style.background !== 'transparent') {
                el.style.background = '';
                highlights = highlights.filter(x => x.id !== id);
            } else {
                el.style.background = activeColor;
                highlights.push({id, text, color: activeColor});
            }
            localStorage.setItem('myHighlights', JSON.stringify(highlights));
        }

        function undoHighlight() {
            const last = highlights.pop();
            if(last) { 
                const el = document.getElementById(last.id);
                if(el) el.style.background = '';
                localStorage.setItem('myHighlights', JSON.stringify(highlights));
            }
        }

        function startNoteTimer(id) { pressTimer = setTimeout(() => {
            const msg = prompt("Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ©:", ayahNotes[id]?.text || "");
            if(msg !== null) {
                if(msg.trim()) ayahNotes[id] = {text: msg, sura: quranData[curSura].name}; 
                else delete ayahNotes[id];
                localStorage.setItem('myNotes', JSON.stringify(ayahNotes));
                renderPage(); refreshNotesUI();
            }
        }, 800); }
        function clearNoteTimer() { clearTimeout(pressTimer); }

        function refreshNotesUI() {
            document.getElementById('notes-container').innerHTML = Object.values(ayahNotes).map(n => 
                `<div style="padding:12px; border-bottom:1px solid #eee; background:#f9f9f9; margin-bottom:5px; border-radius:5px;">
                    <b style="color:var(--primary)">${n.sura}:</b> ${n.text}
                </div>`).join('') || "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>";
        }

        function doSearch(q) {
            let resHtml = '';
            if(q.length > 1) {
                quranData.forEach((s, si) => s.ayahs.forEach(a => {
                    if(a.text.includes(q)) resHtml += `<div onclick="jumpToSura(${si})" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;"><b>${s.name}:</b> ${a.text}</div>`;
                }));
            }
            document.getElementById('results').innerHTML = resHtml;
        }

        function jumpToSura(i) { curSura = i; renderPage(); closePanels(); }
        function handleTS(e) { touchX = e.touches[0].clientX; }
        function handleTE(e) {
            let xu = e.changedTouches[0].clientX;
            if(!touchX || Math.abs(touchX-xu) < 60) return;
            if(touchX > xu) { if(curSura < 113) curSura++; } else { if(curSura > 0) curSura--; }
            renderPage(); touchX = null;
        }

        function toggleMenus() { document.getElementById('main-footer').classList.toggle('active'); }
        function showPenTools() { document.getElementById('pen-tools').classList.add('active'); toggleMenus(); }
        function hidePen() { document.getElementById('pen-tools').classList.remove('active'); }
        function openPanel(id) { document.getElementById(id).classList.add('active'); toggleMenus(); }
        function closePanels() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); }
        function setCol(c) { activeColor = c; }
        function toggleDarkMode() { document.body.classList.toggle('dark'); }

        initApp();
    </script>
</body>
</html>
